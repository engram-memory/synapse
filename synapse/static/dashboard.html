<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synapse Dashboard</title>
<style>
  :root {
    --bg: #0a0e17;
    --surface: #111827;
    --surface2: #1a2234;
    --border: #1e293b;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --accent: #3b82f6;
    --green: #22c55e;
    --red: #ef4444;
    --amber: #f59e0b;
    --purple: #a855f7;
    --cyan: #06b6d4;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace;
    font-size: 13px;
    line-height: 1.5;
    min-height: 100vh;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header h1 {
    font-size: 18px;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
  }
  .header h1 span { color: var(--accent); }
  .header-stats {
    display: flex;
    gap: 24px;
    font-size: 12px;
    color: var(--text2);
  }
  .header-stats .val { color: var(--text); font-weight: 600; }
  .refresh-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--green);
    margin-right: 6px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Grid */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    padding: 16px 24px;
  }
  @media (max-width: 900px) {
    .grid { grid-template-columns: 1fr; }
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text2);
  }
  .card-header .badge {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 500;
  }
  .card-body { padding: 12px 16px; }

  /* Agent Cards */
  .agents-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    grid-column: 1 / -1;
  }
  .agent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: border-color 0.3s;
  }
  .agent-card:hover { border-color: var(--accent); }
  .agent-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .agent-name {
    font-size: 15px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .status-led {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-led.online {
    background: var(--green);
    box-shadow: 0 0 8px var(--green);
  }
  .status-led.offline {
    background: var(--red);
    box-shadow: 0 0 8px var(--red);
  }
  .agent-caps {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  .cap-tag {
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 10px;
    background: var(--surface2);
    color: var(--text2);
    border: 1px solid var(--border);
  }
  .agent-hb {
    font-size: 11px;
    color: var(--text2);
  }

  /* Feed */
  .feed-item {
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 10px;
    align-items: flex-start;
    font-size: 12px;
  }
  .feed-item:last-child { border-bottom: none; }
  .feed-time {
    color: var(--text2);
    white-space: nowrap;
    min-width: 100px;
    font-size: 11px;
  }
  .feed-event {
    padding: 1px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
  }
  .feed-event.trade_closed { background: #1e3a5f; color: var(--cyan); }
  .feed-event.trade_opened { background: #1a3329; color: var(--green); }
  .feed-event.cycle_start { background: #2d1f4e; color: var(--purple); }
  .feed-event.swarm_decision { background: #3b2f1a; color: var(--amber); }
  .feed-event.volatility_regime { background: #1e293b; color: var(--text2); }
  .feed-event.symbol_skipped { background: #1e293b; color: var(--text2); }
  .feed-event.alert { background: #3b1a1a; color: var(--red); }
  .feed-detail { color: var(--text); }

  .pnl-pos { color: var(--green); font-weight: 700; }
  .pnl-neg { color: var(--red); font-weight: 700; }

  /* Genesis Mood */
  .mood-display {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 8px 0;
  }
  .mood-emoji { font-size: 36px; }
  .mood-info { flex: 1; }
  .mood-dominant {
    font-size: 18px;
    font-weight: 700;
    text-transform: capitalize;
  }
  .mood-bar-container {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 8px;
  }
  .mood-bar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    min-width: 60px;
  }
  .mood-bar-fill {
    width: 100%;
    height: 6px;
    background: var(--surface2);
    border-radius: 3px;
    overflow: hidden;
  }
  .mood-bar-fill > div {
    height: 100%;
    border-radius: 3px;
    min-width: 2px;
    transition: width 0.5s ease;
  }
  .mood-bar-label { font-size: 9px; color: var(--text2); text-transform: uppercase; }
  .mood-bar-val { font-size: 11px; font-weight: 600; }
  .mood-detail {
    display: flex;
    gap: 16px;
    margin-top: 6px;
    font-size: 11px;
    color: var(--text2);
  }
  .mood-detail span { color: var(--text); }

  /* Bus stats */
  .bus-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }
  .bus-stat {
    text-align: center;
    padding: 10px;
    background: var(--surface2);
    border-radius: 6px;
  }
  .bus-stat .num {
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
  }
  .bus-stat .label {
    font-size: 10px;
    color: var(--text2);
    text-transform: uppercase;
    margin-top: 2px;
  }

  /* Channel breakdown */
  .ch-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 12px;
  }
  .ch-name { color: var(--cyan); }
  .ch-count { color: var(--text2); }

  /* Last trade card */
  .last-trade {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #0f1a2e 0%, #162032 100%);
    border: 1px solid var(--accent);
  }
  .last-trade .card-header { background: rgba(59,130,246,0.1); border-color: var(--accent); }
  .trade-hero {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 0;
  }
  .trade-symbol { font-size: 22px; font-weight: 700; }
  .trade-direction {
    padding: 2px 10px;
    border-radius: 4px;
    font-weight: 700;
    font-size: 12px;
  }
  .trade-direction.SHORT { background: #3b1a1a; color: var(--red); }
  .trade-direction.LONG { background: #1a3329; color: var(--green); }
  .trade-pnl { font-size: 28px; font-weight: 700; }
  .trade-meta {
    display: flex;
    gap: 20px;
    font-size: 12px;
    color: var(--text2);
    margin-top: 4px;
  }
  .trade-meta span { color: var(--text); }

  /* Footer */
  .footer {
    text-align: center;
    padding: 16px;
    color: var(--text2);
    font-size: 11px;
    border-top: 1px solid var(--border);
  }

  /* Empty state */
  .empty { color: var(--text2); font-style: italic; padding: 12px 0; }
</style>
</head>
<body>

<div class="header">
  <h1><span>Synapse</span> Dashboard</h1>
  <div class="header-stats">
    <div><span class="refresh-dot"></span>Live <span class="val" id="refresh-counter">10s</span></div>
    <div>Messages: <span class="val" id="total-msgs">-</span></div>
    <div>Agents: <span class="val" id="online-agents">-</span></div>
    <div>Uptime: <span class="val" id="uptime">-</span></div>
  </div>
</div>

<!-- Last Trade Hero -->
<div style="padding: 16px 24px 0;">
  <div class="last-trade card" id="last-trade-card" style="display:none;">
    <div class="card-header">LAST TRADE <span class="badge" id="trade-time" style="color:var(--text2)"></span></div>
    <div class="card-body">
      <div class="trade-hero">
        <div>
          <span class="trade-direction" id="trade-dir"></span>
          <span class="trade-symbol" id="trade-sym"></span>
        </div>
        <div class="trade-pnl" id="trade-pnl"></div>
      </div>
      <div class="trade-meta" id="trade-meta"></div>
    </div>
  </div>
</div>

<!-- Agent Cards -->
<div style="padding: 16px 24px 0;">
  <div class="agents-grid" id="agents-grid"></div>
</div>

<div class="grid">
  <!-- Market Data Feed -->
  <div class="card">
    <div class="card-header">#market-data <span class="badge" style="color:var(--cyan);" id="md-count">0</span></div>
    <div class="card-body" id="market-feed"></div>
  </div>

  <!-- Genesis Mood -->
  <div class="card">
    <div class="card-header">Genesis Cognitive State <span class="badge" style="color:var(--purple);" id="genesis-trend">-</span></div>
    <div class="card-body" id="genesis-mood">
      <div class="empty">Waiting for Genesis data...</div>
    </div>
  </div>

  <!-- Alerts Feed -->
  <div class="card">
    <div class="card-header">#alerts <span class="badge" style="color:var(--red);" id="alerts-count">0</span></div>
    <div class="card-body" id="alerts-feed"></div>
  </div>

  <!-- Bus Stats -->
  <div class="card">
    <div class="card-header">Bus Statistics</div>
    <div class="card-body">
      <div class="bus-stats" id="bus-stats"></div>
      <div style="margin-top:12px;" id="channel-breakdown"></div>
    </div>
  </div>
</div>

<div class="footer">
  Synapse v0.1.0 &mdash; Agent-to-Agent Communication Layer &mdash; <span id="last-update"></span>
</div>

<script>
const API = window.location.origin;
let serverStartedAt = null;
let countdown = 10;

const MOOD_EMOJIS = {
  curiosity: 'ðŸ”', connection: 'ðŸ¤', satisfaction: 'ðŸ˜Œ',
  stress: 'ðŸ˜°', frustration: 'ðŸ˜¤', boredom: 'ðŸ˜',
  neutral: 'ðŸ§ ', excitement: 'ðŸ¤©', focus: 'ðŸŽ¯'
};

const MOOD_COLORS = {
  curiosity: '#f59e0b', connection: '#a855f7', satisfaction: '#22c55e',
  stress: '#ef4444', frustration: '#ef4444', boredom: '#64748b',
  neutral: '#94a3b8', excitement: '#f59e0b', focus: '#3b82f6'
};

function fmtTime(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${dd}.${mm} ${hh}:${mi}`;
}

function fmtDate(iso) {
  return fmtTime(iso);
}

function fmtPnl(v) {
  const sign = v >= 0 ? '+' : '';
  const cls = v >= 0 ? 'pnl-pos' : 'pnl-neg';
  return `<span class="${cls}">${sign}$${v.toFixed(2)}</span>`;
}

function renderAgents(agents) {
  const grid = document.getElementById('agents-grid');
  const online = agents.filter(a => a.status === 'online').length;
  document.getElementById('online-agents').textContent = `${online}/${agents.length}`;

  grid.innerHTML = agents.map(a => {
    const isOnline = a.status === 'online';
    const ledClass = isOnline ? 'online' : 'offline';
    const caps = (a.capabilities || []).map(c => `<span class="cap-tag">${c}</span>`).join('');
    const hb = a.last_heartbeat ? fmtTime(a.last_heartbeat) : 'never';
    return `
      <div class="agent-card">
        <div class="agent-top">
          <div class="agent-name">
            <div class="status-led ${ledClass}"></div>
            ${a.name}
          </div>
          <span style="font-size:11px;color:${isOnline ? 'var(--green)' : 'var(--red)'};font-weight:600;">
            ${a.status.toUpperCase()}
          </span>
        </div>
        <div class="agent-caps">${caps}</div>
        <div class="agent-hb">Last heartbeat: ${hb}</div>
      </div>`;
  }).join('');
}

function renderMarketFeed(msgs) {
  const el = document.getElementById('market-feed');
  document.getElementById('md-count').textContent = msgs.length;
  if (!msgs.length) { el.innerHTML = '<div class="empty">No market data yet</div>'; return; }

  el.innerHTML = msgs.map(m => {
    const p = m.payload || {};
    const ev = p.event || '?';
    const time = fmtTime(m.timestamp);
    let detail = '';

    if (ev === 'trade_closed') {
      detail = `${p.symbol} | ${p.reason} | ${fmtPnl(p.pnl_usd || 0)}`;
    } else if (ev === 'trade_opened') {
      detail = `${p.direction} ${p.symbol} | Conf=${p.confidence || 0}%`;
      if (p.entry) detail += ` | Entry: $${Number(p.entry).toLocaleString()}`;
    } else if (ev === 'cycle_start') {
      detail = `Cycle #${p.cycle} started`;
    } else if (ev === 'swarm_decision') {
      detail = `${p.action} ${p.symbol} | Conf=${(p.confidence||0).toFixed(1)}% | Consensus=${(p.consensus||0).toFixed(1)}%`;
    } else if (ev === 'volatility_regime') {
      const mult = p.size_multiplier != null ? ` | Size: ${p.size_multiplier}x` : '';
      detail = `${p.symbol} ${p.regime} (${(p.confidence_pct||0).toFixed(1)}%)${mult}`;
    } else if (ev === 'symbol_skipped') {
      detail = `${p.symbol} â€” ${p.reason}`;
    } else if (ev === 'regime_change') {
      detail = `Vol=${p.volatility} | Trend=${p.trend} | Sentiment=${p.sentiment} | BTC=${p.btc_bias}`;
    } else if (ev === 'signal_detected') {
      detail = `${p.direction} ${p.symbol} | ${p.strategy} | Str=${p.strength} | Conf=${p.confidence}%`;
    } else {
      // Human-readable fallback: show key fields
      const skip = ['event'];
      const parts = Object.entries(p)
        .filter(([k]) => !skip.includes(k))
        .map(([k, v]) => `${k}=${typeof v === 'number' ? v.toLocaleString() : v}`)
        .slice(0, 4);
      detail = parts.join(' | ');
    }

    return `<div class="feed-item">
      <span class="feed-time">${time}</span>
      <span class="feed-event ${ev}">${ev.replace('_',' ')}</span>
      <span class="feed-detail">${detail}</span>
    </div>`;
  }).join('');

  // Update last trade hero
  const trades = msgs.filter(m => ['trade_closed','trade_opened'].includes(m.payload?.event));
  if (trades.length) {
    const last = trades[trades.length - 1];
    const p = last.payload;
    const card = document.getElementById('last-trade-card');
    card.style.display = 'block';
    document.getElementById('trade-time').textContent = fmtDate(last.timestamp);

    if (p.event === 'trade_closed') {
      document.getElementById('trade-dir').textContent = '';
      document.getElementById('trade-dir').className = 'trade-direction';
      document.getElementById('trade-sym').textContent = p.symbol;
      const pnl = p.pnl_usd || 0;
      document.getElementById('trade-pnl').innerHTML = fmtPnl(pnl);
      document.getElementById('trade-meta').innerHTML =
        `Reason: <span>${p.reason}</span>`;
    } else {
      document.getElementById('trade-dir').textContent = p.direction;
      document.getElementById('trade-dir').className = `trade-direction ${p.direction}`;
      document.getElementById('trade-sym').textContent = p.symbol;
      document.getElementById('trade-pnl').textContent = `${p.confidence || 0}%`;
      document.getElementById('trade-meta').innerHTML =
        `Entry: <span>$${(p.entry||0).toFixed(2)}</span> | ` +
        `SL: <span>$${(p.stop_loss||0).toFixed(2)}</span> | ` +
        `TP: <span>$${(p.take_profit||0).toFixed(2)}</span>`;
    }
  }
}

function renderAlerts(msgs) {
  const el = document.getElementById('alerts-feed');
  document.getElementById('alerts-count').textContent = msgs.length;
  if (!msgs.length) { el.innerHTML = '<div class="empty">No alerts</div>'; return; }

  el.innerHTML = msgs.map(m => {
    const p = m.payload || {};
    const time = fmtTime(m.timestamp);
    // Human-readable alert text
    let text = p.message || '';
    if (!text) {
      if (p.event === 'genesis_offline') text = 'Genesis daemon is not responding';
      else if (p.event === 'agents_timed_out') text = `Agents timed out: ${(p.agents||[]).join(', ')}`;
      else text = Object.entries(p).filter(([k])=>k!=='event').map(([k,v])=>`${k}=${v}`).slice(0,3).join(', ');
    }
    // Truncate long messages
    if (text.length > 100) text = text.slice(0, 97) + '...';
    return `<div class="feed-item">
      <span class="feed-time">${time}</span>
      <span class="feed-event alert">alert</span>
      <span class="feed-detail">${m.sender}: ${text}</span>
    </div>`;
  }).join('');
}

function renderGenesisMood(msgs) {
  const el = document.getElementById('genesis-mood');
  const trendEl = document.getElementById('genesis-trend');

  const emoMsgs = msgs.filter(m => m.payload?.event === 'emotion_change');
  if (!emoMsgs.length) { el.innerHTML = '<div class="empty">No emotion data</div>'; return; }

  const latest = emoMsgs[emoMsgs.length - 1].payload.emotions || {};
  const state = latest.current_state || {};
  const dominant = state.dominant || 'neutral';
  const valence = state.valence || 0;
  const trend = latest.trend || 'unknown';
  trendEl.textContent = trend;

  const emotions = ['curiosity','connection','satisfaction','stress','frustration','boredom'];

  const valSign = valence >= 0 ? '+' : '';
  const valColor = valence > 0.15 ? 'var(--green)' : valence < -0.1 ? 'var(--red)' : 'var(--text2)';

  el.innerHTML = `
    <div class="mood-display">
      <div class="mood-emoji">${MOOD_EMOJIS[dominant] || 'ðŸ§ '}</div>
      <div class="mood-info">
        <div class="mood-dominant" style="color:${MOOD_COLORS[dominant] || '#94a3b8'}">${dominant}</div>
        <div class="mood-detail">
          Valence: <span style="color:${valColor}">${valSign}${valence.toFixed(3)}</span>
          Avg: <span>${(latest.average_valence||0).toFixed(3)}</span>
          History: <span>${latest.history_size || 0}</span>
        </div>
      </div>
    </div>
    <div class="mood-bar-container">
      ${emotions.map(e => {
        const val = state[e] || 0;
        const pct = Math.round(val * 100);
        const displayPct = Math.max(pct, val > 0 ? 3 : 0); // min visible bar
        const color = MOOD_COLORS[e] || '#64748b';
        const isDominant = e === dominant;
        const labelStyle = isDominant ? `color:${color};font-weight:700` : '';
        return `<div class="mood-bar">
          <div class="mood-bar-fill"><div style="width:${displayPct}%;background:${color}"></div></div>
          <div class="mood-bar-label" style="${labelStyle}">${e} ${pct}%</div>
        </div>`;
      }).join('')}
    </div>`;
}

function renderBusStats(health) {
  const stats = document.getElementById('bus-stats');
  const storage = health.storage || {};
  const byCh = storage.by_channel || {};

  stats.innerHTML = `
    <div class="bus-stat"><div class="num">${(storage.total_messages||0).toLocaleString()}</div><div class="label">Messages</div></div>
    <div class="bus-stat"><div class="num">${health.subscriptions || 0}</div><div class="label">Subscriptions</div></div>
    <div class="bus-stat"><div class="num">${(storage.db_size_mb||0).toFixed(2)}</div><div class="label">DB Size (MB)</div></div>`;

  const bd = document.getElementById('channel-breakdown');
  bd.innerHTML = Object.entries(byCh).sort((a,b) => b[1] - a[1]).map(([ch, count]) =>
    `<div class="ch-row"><span class="ch-name">${ch}</span><span class="ch-count">${count.toLocaleString()}</span></div>`
  ).join('');
}

async function fetchJSON(path) {
  const r = await fetch(API + path);
  return r.json();
}

async function refresh() {
  try {
    const [health, agents, market, alerts, system] = await Promise.all([
      fetchJSON('/health'),
      fetchJSON('/agents'),
      fetchJSON('/history/%23market-data?limit=10'),
      fetchJSON('/history/%23alerts?limit=5'),
      fetchJSON('/history/%23system?limit=10'),
    ]);

    document.getElementById('total-msgs').textContent =
      (health.storage?.total_messages || 0).toLocaleString();

    // Track server start time for uptime
    if (health.started_at) serverStartedAt = health.started_at;

    renderAgents(agents.agents || []);
    renderMarketFeed(market.messages || []);
    renderAlerts(alerts.messages || []);
    renderGenesisMood(system.messages || []);
    renderBusStats(health);

    // Server uptime
    if (serverStartedAt) {
      const elapsed = Math.floor((Date.now() - new Date(serverStartedAt).getTime()) / 1000);
      const d = Math.floor(elapsed / 86400);
      const h = Math.floor((elapsed % 86400) / 3600);
      const m = Math.floor((elapsed % 3600) / 60);
      let uptimeStr = '';
      if (d > 0) uptimeStr += d + 'd ';
      if (h > 0) uptimeStr += h + 'h ';
      uptimeStr += m + 'm';
      document.getElementById('uptime').textContent = uptimeStr.trim();
    }
    document.getElementById('last-update').textContent =
      'Updated: ' + new Date().toLocaleTimeString('de-AT');
  } catch (e) {
    console.error('Refresh failed:', e);
  }
}

// Countdown display
setInterval(() => {
  countdown--;
  if (countdown <= 0) { countdown = 10; refresh(); }
  document.getElementById('refresh-counter').textContent = countdown + 's';
}, 1000);

// Initial load
refresh();
</script>
</body>
</html>
